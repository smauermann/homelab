global:
  domain: argocd.costanza.cloud

dex:
  enabled: false

configs:
  params:
    # Run server without TLS
    # Ingress NGINX finishes TLS connections
    server.insecure: true
    controller.diff.server.side: "true"

  secret:
    # authentication of GitHub webhook events
    # this will look up the secret in another secret with the specified key, see https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/#alternative
    githubSecret: "$argocd-github-webhook-secret:credential"

  rbac:
    policy.csv: |
      g, argocd:admins, role:admin

  cm:
    url: https://argocd.costanza.cloud
    oidc.config: |
      name: 'Authelia'
      issuer: 'https://authelia.costanza.cloud'
      clientID: 'argocd'
      clientSecret: '$argocd-oidc-client-secret:secret'
      requestedScopes:
        - 'openid'
        - 'profile'
        - 'email'
        - 'groups'
    repositories: |
      - url: https://github.com/smauermann/homelab
        passwordSecret:
          name: argocd-repo-github-homelab
          key: password
        usernameSecret:
          name: argocd-repo-github-homelab
          key: username

    # use annotation tracking method, this will be the default in v3
    application.resourceTrackingMethod: annotation+label

    # Adding Applications health check
    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Progressing"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs
    # Kustomize build options
    # --enable-helm: Enabling Helm chart rendering with Kustomize
    # --load-restrictor LoadRestrictionsNone: Local kustomizations may load files from outside their root
    kustomize.buildOptions: --enable-helm --load-restrictor LoadRestrictionsNone
    ## Ignore resources
    # https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#resource-exclusioninclusion
    # Ignore VolumeSnapshot and VolumeSnapshotContent: Created by backup processes.
    resource.exclusions: |
      - apiGroups:
        - snapshot.storage.k8s.io
        kinds:
        - VolumeSnapshot
        - VolumeSnapshotContent
        clusters:
        - "*"
      - apiGroups:
          - cilium.io
        kinds:
          - CiliumIdentity
        clusters:
          - "*"

server:
  # Ingress Resource.
  ingress:
    ## Enable creation of ingress resource
    enabled: true
    ## Add ingressClassName to the Ingress
    ingressClassName: cilium
    # ingress host
    hostname: argocd.costanza.cloud
    ## Default ingress path
    path: /
    pathType: Prefix
    # Enable tls. argocd-server-tls secret is created automatically for hostname
    tls: true

    ## Ingress annotations
    annotations:
      # Linkerd configuration. Configure Service as Upstream
      # nginx.ingress.kubernetes.io/service-upstream: "true"
      # Enable cert-manager to create automatically the SSL certificate and store in Secret
      # Possible Cluster-Issuer values:
      #   * 'letsencrypt-issuer' (valid TLS certificate using IONOS API)
      #   * 'ca-issuer' (CA-signed certificate, not valid)
      cert-manager.io/cluster-issuer: letsencrypt-prod
      cert-manager.io/common-name: argocd.costanza.cloud
      gethomepage.dev/description: GitOps Controller
      gethomepage.dev/enabled: "true"
      gethomepage.dev/group: Workloads
      gethomepage.dev/icon: argo-cd.png
      gethomepage.dev/name: ArgoCD
      gethomepage.dev/pod-selector: ""
