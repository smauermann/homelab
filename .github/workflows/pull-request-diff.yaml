name: Pull Request Diff

on:
  pull_request:
    paths:
      - kubernetes/**
    branches:
      - main

jobs:
  changed:
    name: Changed Kubernetes Files
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
      dirs: ${{ steps.changed-files.outputs.all_changed_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@e0021407031f5be11a464abee9a0776171c79891 # v47.0.1
        with:
          files: kubernetes/**
          files_ignore: kubernetes/components/**
          dir_names: true
          dir_names_max_depth: 5
          matrix: true

  resolve:
    name: Resolve ArgoCD Apps
    needs: changed
    if: ${{ needs.changed.outputs.any_changed == 'true' }}
    runs-on: homelab-runner
    outputs:
      matrix: ${{ steps.resolve.outputs.matrix }}
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: argocd-server.argocd.svc.cluster.local
          ARGOCD_OPTS: "--plaintext"
        run: |
          argocd login "$ARGOCD_SERVER" --username githubActions --password "${{ secrets.ARGOCD_GITHUB_ACTIONS_PASSWORD }}"

      - name: Resolve directories to apps
        id: resolve
        env:
          ARGOCD_SERVER: argocd-server.argocd.svc.cluster.local
          ARGOCD_OPTS: "--plaintext"
          ALL_CHANGED_DIRS: ${{ needs.changed.outputs.dirs }}
        run: |
          echo "Changed directories: $ALL_CHANGED_DIRS"

          resolve_app() {
            local dir="$1"
            while [[ "$dir" == kubernetes/* ]]; do
              local app_name=$(basename "$dir")
              if argocd app get "$app_name" > /dev/null 2>&1; then
                echo "$app_name"
                return 0
              fi
              dir=$(dirname "$dir")
            done
            # No existing app found - return basename as new app
            basename "$1"
          }

          declare -A SEEN_APPS
          APPS=()

          for dir in $(echo "$ALL_CHANGED_DIRS" | jq -r '.[]'); do
            app=$(resolve_app "$dir")
            if [[ -n "$app" ]] && [[ -z "${SEEN_APPS[$app]}" ]]; then
              SEEN_APPS[$app]=1
              APPS+=("$app")
              echo "Resolved $dir -> $app"
            else
              echo "Skipping $dir (already have $app)"
            fi
          done

          if [[ ${#APPS[@]} -gt 0 ]]; then
            MATRIX_JSON=$(printf '%s\n' "${APPS[@]}" | jq -R . | jq -s -c '{apps: .}')
          else
            MATRIX_JSON='{"apps":[]}'
          fi

          echo "Matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  diff:
    name: ArgoCD Diff
    needs: resolve
    if: ${{ fromJSON(needs.resolve.outputs.matrix).apps[0] != null }}
    strategy:
      matrix: ${{ fromJSON(needs.resolve.outputs.matrix) }}
      max-parallel: 4
      fail-fast: false
    permissions:
      contents: read
      pull-requests: write
    runs-on: homelab-runner

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Login to ArgoCD
        env:
          ARGOCD_SERVER: argocd-server.argocd.svc.cluster.local
          ARGOCD_OPTS: "--plaintext"
        run: |
          argocd login "$ARGOCD_SERVER" --username githubActions --password "${{ secrets.ARGOCD_GITHUB_ACTIONS_PASSWORD }}"

      - name: Run ArgoCD diff
        id: diff
        env:
          ARGOCD_SERVER: argocd-server.argocd.svc.cluster.local
          ARGOCD_OPTS: "--plaintext"
        run: |
          APP_NAME="${{ matrix.apps }}"
          PR_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Checking diff for app: $APP_NAME at revision: $PR_SHA"

          # Check if app exists (might be new)
          if ! argocd app get "$APP_NAME" > /dev/null 2>&1; then
            echo "status=new_app" >> $GITHUB_OUTPUT
            echo "App '$APP_NAME' does not exist in ArgoCD yet (new app)"
            exit 0
          fi

          # Run diff with the PR revision
          set +e
          DIFF_OUTPUT=$(argocd app diff "$APP_NAME" --revision "$PR_SHA" 2>&1)
          DIFF_EXIT_CODE=$?
          set -e

          # Exit code 0 = no diff, 1 = has diff, 2+ = error
          if [[ $DIFF_EXIT_CODE -eq 0 ]]; then
            echo "status=no_diff" >> $GITHUB_OUTPUT
            echo "No differences found for $APP_NAME" >> $GITHUB_STEP_SUMMARY
          elif [[ $DIFF_EXIT_CODE -eq 1 ]]; then
            echo "status=has_diff" >> $GITHUB_OUTPUT
            echo "$DIFF_OUTPUT" > diff.txt
            {
              echo "### ArgoCD Diff for \`$APP_NAME\`"
              echo '```diff'
              cat diff.txt
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "Error running diff for $APP_NAME: $DIFF_OUTPUT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Find existing comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4
        id: fc
        if: ${{ steps.diff.outputs.status == 'has_diff' || steps.diff.outputs.status == 'new_app' }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: ArgoCD Diff for `${{ matrix.apps }}`

      - name: Create comment body
        if: ${{ steps.diff.outputs.status == 'has_diff' || steps.diff.outputs.status == 'new_app' }}
        run: |
          APP_NAME="${{ matrix.apps }}"
          STATUS="${{ steps.diff.outputs.status }}"

          if [[ "$STATUS" == "new_app" ]]; then
            cat > comment.md << EOF
          ### ArgoCD Diff for \`$APP_NAME\`

          **New Application**

          This PR introduces a new ArgoCD application. The app will be created when the ApplicationSet detects this directory after merge.
          EOF
          else
            DIFF_CONTENT=$(cat diff.txt)
            cat > comment.md << EOF
          ### ArgoCD Diff for \`$APP_NAME\`

          <details>
          <summary>Expand Diff</summary>

          \`\`\`diff
          ${DIFF_CONTENT}
          \`\`\`

          </details>
          EOF
          fi

      - name: Post comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5
        if: ${{ steps.diff.outputs.status == 'has_diff' || steps.diff.outputs.status == 'new_app' }}
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comment.md
          edit-mode: replace

