global:
  domain: argocd.costanza.cloud

dex:
  enabled: false

configs:
  params:
    # Run server without TLS
    # Ingress NGINX finishes TLS connections
    server.insecure: true
    controller.diff.server.side: "true"
    # Preserve the 5s delay between self-heal retries instead of the upstream 0s default.
    controller.self.heal.timeout.seconds: "5"
    # Keep enforcing sync policy to match pre-upgrade behaviour.
    applicationsetcontroller.policy: sync

  secret:
    # authentication of GitHub webhook events
    # this will look up the secret in another secret with the specified key, see https://argo-cd.readthedocs.io/en/stable/operator-manual/webhook/#alternative
    githubSecret: "$argocd-github-webhook-secret:credential"

  rbac:
    policy.csv: |
      g, admins, role:admin
      g, argocd:admins, role:admin
      g, githubActions, role:readonly

  cm:
    url: https://argocd.costanza.cloud
    accounts.githubActions: apiKey, login
    oidc.config: |
      name: 'Pocket ID'
      issuer: 'https://pid.costanza.cloud'
      clientID: 'argocd'
      clientSecret: '$argocd-oidc-secret:secret'
      requestedScopes:
        - 'openid'
        - 'profile'
        - 'email'
        - 'groups'

    # use annotation tracking method, this will be the default in v3
    application.resourceTrackingMethod: annotation+label

    # Adding Applications health check
    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Progressing"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs
    # Kustomize build options
    # --enable-helm: Enabling Helm chart rendering with Kustomize
    # --load-restrictor LoadRestrictionsNone: Local kustomizations may load files from outside their root
    kustomize.buildOptions: --enable-helm --load-restrictor LoadRestrictionsNone
    ## Ignore resources
    # https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#resource-exclusioninclusion
    # Ignore VolumeSnapshot and VolumeSnapshotContent: Created by backup processes.
    resource.exclusions: |
      - apiGroups:
        - snapshot.storage.k8s.io
        kinds:
        - VolumeSnapshot
        - VolumeSnapshotContent
        clusters:
        - "*"
      - apiGroups:
          - cilium.io
        kinds:
          - CiliumIdentity
        clusters:
          - "*"

# Pin kustomize to 5.7.1 to work around namespace bug in 5.8.0
# https://github.com/kubernetes-sigs/kustomize/issues/6014
repoServer:
  volumes:
    - name: custom-tools
      emptyDir: {}
  initContainers:
    - name: download-kustomize
      image: alpine:3.23@sha256:25109184c71bdad752c8312a8623239686a9a2071e8825f20acb8f2198c3f659
      command: [sh, -c]
      args:
        - wget -qO- https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.7.1/kustomize_v5.7.1_linux_amd64.tar.gz | tar -xzf - -C /custom-tools/
      volumeMounts:
        - mountPath: /custom-tools
          name: custom-tools
  volumeMounts:
    - mountPath: /usr/local/bin/kustomize
      name: custom-tools
      subPath: kustomize

server:
  ingress:
    enabled: false
